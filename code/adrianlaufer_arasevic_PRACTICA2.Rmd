---
title: "Practica 2"
author: "Aleksandar Arasevic y Adrian Läufer"
date: "Junio 2023"
output: 
  html_document:
    highlight: default
    number_sections: yes
    theme: cosmo
    toc: yes
    toc_depth: 2
  pdf_document:
    highlight: zenburn
    toc: yes
  word_document: default
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

------------------------------------------------------------------------

# Planteamiento del problema

------------------------------------------------------------------------

En la Práctica 1 realizamos webscraping a dos portales immobiliarios de Internet (Fotocasa.es y elidealista.com) con el objetivo de obtener todas las viviendas en venta en el municipio de Vilanova y la Geltrú. En esta segunda Práctica utilizaremos los dos datasets obtenidos entonces para realizar diferentes análisis.

El primer análisis que realizaremos será ver si existen correlaciones entre los metros cuadrados de superficie de los pisos y el precio de los pisos. Este análisis lo realizaremos para los diferentes grupos de viviendas: pisos y chalets o casas. Además, diferenciaremos en los pisos en función del número de habitaciones para ver si la correlación difiere mucho en función del número de habitaciones que tienen los pisos. Además intentaremos identificar que efecto tienen sobre el precio del piso ciertas propiedades como pueden ser tener una plaza de parking o tener una piscina.

Este tipo de análisis tiene una especial importancia a la hora de invertir en un piso, ya que con ello se pueden identificar pisos ganga o viviendas con un precio es excesivo y por las cuales podemos como inversores negociar un mejor precio.

El segundo análisis que intentaremos realizar consistirá en identificar las mismas viviendas ofertadas en los mismos portales immobiliarios y ver si existen diferencias en los precios propuestos.

------------------------------------------------------------------------

# Integración y selección

------------------------------------------------------------------------

La integración de los datos la realizaremos para los dos datasets obtenidos de forma diferente, ya que el formato de los datos extraidos difiere algo de cada portal immobiliario. Una vez realizada la integración, juntaremos los dos datasets y realizaremos la selección de los datos que utlizaremos para el futuro análisis.

## Datos de fotocasa

En primer lugar importaremos el archivo output_fotocasa.csv con los dato del webscraping del portal fotocasa.es

```{r message= FALSE, warning=FALSE}
data_fotocasa <- read.csv('output_fotocasa.csv')
```

Con la función summary vemos que todos los datos importados tienen la misma longitud y que son del mismo tipo, en este caso del tipo carácter.
```{r message= FALSE, warning=FALSE}
summary(data_fotocasa)
```

A continuación vemos una extracción de los veinte primeros registros con tal de ver como están los datos estructurados.
```{r message= FALSE, warning=FALSE}
head(data_fotocasa,20)
```

Tal y como vemos en la columna "title", la primera palabra de cada registro indica el tipo de viviend aque es. Con tal de poder distinguir en función de este parámetro, crearemos la variable tipo de vivienda, que extrae la primera palabra del registro title.

```{r message= FALSE, warning=FALSE}
library(dplyr)
data_fotocasa$tipo_vivienda <- gsub(" .*$","",data_fotocasa$title)
```

Las columnas "rooms", "price" y "surface" se deben de transformar en valores numéricos ya que indican el número de habitaciones, el precio de la vivienda o los metros cuadrados que tienen la vivienda. Para ello extraeremos los números de cada una de sus respectivas columnas y transformaremos mediante as.numeric la columna del tipo character en numérica.

```{r message= FALSE, warning=FALSE}
data_fotocasa$rooms <- substr(data_fotocasa$rooms, 0, 1)
data_fotocasa$rooms <- as.numeric(data_fotocasa$rooms)
```

```{r message= FALSE, warning=FALSE}
data_fotocasa$price <- sub("*.\200","",data_fotocasa$price)
data_fotocasa$price <- gsub("\\.","",data_fotocasa$price)
data_fotocasa$price <- as.numeric(data_fotocasa$price)
```

```{r message= FALSE, warning=FALSE}
data_fotocasa$surface <- gsub(" .*$","",data_fotocasa$surface)
data_fotocasa$surface <- as.numeric(data_fotocasa$surface)
```

Por otra parte, las columnas "swimming_pool", "parking" y "elevator" se pueden transformar en variables booleans con tal de facilitar el posterior análisis. Para ello utilizaremos la función as.logical una vez que hemos identificado los valores verdaderos.

```{r message= FALSE, warning=FALSE}
data_fotocasa$swimming_pool[data_fotocasa$swimming_pool == "Piscina"] <- TRUE
data_fotocasa$swimming_pool[data_fotocasa$swimming_pool == ""] <- FALSE
data_fotocasa$swimming_pool <- as.logical(data_fotocasa$swimming_pool)
```

```{r message= FALSE, warning=FALSE}
data_fotocasa$parking[data_fotocasa$parking == "Parking"] <- TRUE
data_fotocasa$parking[data_fotocasa$parking == ""] <- FALSE
data_fotocasa$parking <- as.logical(data_fotocasa$parking)
```


```{r message= FALSE, warning=FALSE}
data_fotocasa$elevator[data_fotocasa$elevator == "Elevator"] <- TRUE
data_fotocasa$elevator[data_fotocasa$elevator == ""] <- FALSE
data_fotocasa$elevator <- as.logical(data_fotocasa$elevator)
```

Por último, añadiremos la columna "source" con el valor constante Fotocasa, con tal de poder distinguir posteriormente entre los datos de fotocasa y elidealista.

```{r message= FALSE, warning=FALSE}
data_fotocasa <- data_fotocasa %>%
  mutate(source = "Fotocasa")
```

```{r message= FALSE, warning=FALSE}
summary(data_fotocasa)
```

## Datos de el idealista

A continuación importamos los datos extraidos del portal el idealista y vemos con la función summary como están compuetos

```{r message= FALSE, warning=FALSE}
data_idealista <- read.csv('output_idealista.csv')
summary(data_idealista)
```

COn tal de poder juntar posteriormente los datos de fotocasa con los del idealista de forma más facil, cambiamos el nombre de ciertas columnas del dataset.

```{r message= FALSE, warning=FALSE}
data_idealista <- data_idealista %>% 
       rename("surface" = "M2",
              "rooms" = "Rooms",
              "title" = "Name",
              "link" = "Link",
              "parking" = "Parking",
              "price" = "Price")
```

A continuación vemos una extracción de los veinte primeros registros con tal de ver como están los datos estructurados.
```{r message= FALSE, warning=FALSE}
head(data_idealista,20)
```

Creamos la misma variable "tipo_vivienda" a partir de extraer la primera palabra del título del registro.
```{r message= FALSE, warning=FALSE}
data_idealista$tipo_vivienda <- gsub(" .*$","",data_idealista$title)
```

Realizamos cambios similares para trasnformar los datos de "rooms", "price" y "surface" en valores numéricos.
```{r message= FALSE, warning=FALSE}
data_idealista$rooms <- sub("*.hab\\.","",data_idealista$rooms)
data_idealista$rooms <- as.numeric(data_idealista$rooms)
```

```{r message= FALSE, warning=FALSE}
data_idealista$price <- sub("*ï¿½","",data_idealista$price)
data_idealista$price <- gsub("\\.","",data_idealista$price)
data_idealista$price <- as.numeric(data_idealista$price)
```

```{r message= FALSE, warning=FALSE}
data_idealista$surface <- sub("*.\\mï¿½","",data_idealista$surface)
data_idealista$surface  <- gsub("\\.","",data_idealista$surface)
data_idealista$surface <- as.numeric(data_idealista$surface)
```

Convertimos la variable parking en una varibale booleana
```{r message= FALSE, warning=FALSE}
data_idealista$parking[data_idealista$parking == "Si"] <- TRUE
data_idealista$parking[data_idealista$parking == "No"] <- FALSE
data_idealista$parking <- as.logical(data_idealista$parking)
```

Por último añadimos la columna "source" con el valor constante "Idealista" para poder identificar los datos de este portal immobiliario.
```{r message= FALSE, warning=FALSE}
data_idealista <- data_idealista %>%
  mutate(source = "Idealista")
```

```{r message= FALSE, warning=FALSE}
summary(data_idealista)
```

## Agragación de los datasets y selección de datos

Una vez preparados los dos datasets de los portales immobiliarios, juantermos los datos en un único dataset.

```{r message= FALSE, warning=FALSE}
data <- full_join(data_fotocasa, data_idealista)
summary(data)
```

Y finalmente, para realizar el análisis, descartaremos las variables "links", "info_card_type", "bathrooms", "heating", "air_conditioner", "balcony" y "terrace", puesto que no nos aportan ningún dato de interés para los análisis que queremos realizar.

```{r message= FALSE, warning=FALSE}
data2 <- subset(data, select=-c(link,info_card_type,bathrooms,heating, air_conditioner, balcony, terrace))
summary(data2)
```

------------------------------------------------------------------------

# Limpieza de datos

------------------------------------------------------------------------







------------------------------------------------------------------------

# Análisis de los datos

------------------------------------------------------------------------